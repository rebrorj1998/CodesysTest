{"payload":{"meta":{"Graph":{"@Type":"81297157","@Value":{"Guid":"(Guid)91e3288c-bb67-4d0f-8f4f-5d2ab405f50f","ParentGuid":"(Guid)00000000-0000-0000-0000-000000000000","Name":"(string)FB_1195_Test_BagDelivery","Properties":{"@Type":"2c41fa04:IDictionary","@Value":[{"@Key":"(Guid)829a18f2-c514-4f6e-9634-1df173429203","@Value":{"@Type":"829a18f2","@Value":{"ParentObjects":{"@Type":"fa2ee218:IDictionary","@Value":[{"@Key":"(Guid)21af5390-2942-461a-bf89-951aaf6999f1","@Value":"(Guid)b98a7fd2-7585-4b42-86af-9cc479901ae8"}]}}}}]},"TypeGuid":"(Guid)6f9dac99-8de1-4efc-8465-68ac443b7d08","EmbeddedTypeGuids":{"@Type":"[Guid]","@Value":["(Guid)a9ed5b7e-75c5-4651-af16-d2c27e98cb94","(Guid)3b83b776-fb25-43b8-99f2-3c507c9143fc"]}}},"TypeInfos":{"2c41fa04":"{2c41fa04-1834-41c1-816e-303c7aa2c05b}","81297157":"{81297157-7ec9-45ce-845e-84cab2b88ade}","829a18f2":"{829a18f2-c514-4f6e-9634-1df173429203}","fa2ee218":"{fa2ee218-a39b-4b6d-b249-49dbddbd168a}","Guid":"System.Guid","string":"System.String"}},"object":{"Graph":{"@Type":"6f9dac99","@Value":{"SpecialFunc":{"@Type":"0db3d7bb:Enum","@Value":"None"},"Implementation":{"@Type":"3b83b776","@Value":{"TextDocument":{"@Type":"f3878285","@Value":{"TextBlobForSerialisation":"(string)SUPER^();\n\n{region \"Axis Setup\"}\n// Setup of Motion Commands for Bag Delivery motor axis\nMC_MoveBagDelivery(Axis := bagDeliveryMotor);\nMC_HaltBagDelivery(Axis := bagDeliveryMotor);\nMC_ResetBagDelivery(Axis := bagDeliveryMotor);\nMC_PowerUpBagDelivery(\n\tenable := F_EtherCatSlaveCommsRunning(state := AZD4A_KED.wState) AND NOT (state = 91), \n\taxis := bagDeliveryMotor\n);\n{endregion}\n\t \n// If reset of motors fails state machine must move on\n_resetTimer(IN := state = 91);\n//moveBagDeliveryTimeout();\n\t \nIF _reset THEN\n\tstate := 90;\n\tnextState := 0;\n\tClearStatus();\n\tMC_ResetBagDelivery.Execute := TRUE;\n\t_reset := FALSE;\nEND_IF\n\n_ready := state = 0 AND bagDeliveryMotor.CommStatus AND NOT bagDeliveryMotor.Error;\nIF bagDeliveryMotor.Error THEN\n\tmotorFault.faultTrigger := TRUE;\nELSE \n\tmotorFault.faultTrigger := FALSE;\nEND_IF\n\nIF NOT bagDeliveryMotor.CommStatus THEN\n\tmotorCommFault.faultTrigger := TRUE;\nELSE\n\tmotorCommFault.faultTrigger := FALSE;\nEND_IF\n\nIF trapezoidalPercent <= 0 THEN\n\ttrapezoidalPercent := 0.1;\nEND_IF\n\nCASE state OF\n\t\n\t0:\t\t\n\t\t\tMC_ResetBagDelivery.Execute := FALSE;\n\t\t\t// Idle\n\t\t\tIF _feedBagOut THEN\n\t\t\t\tstate := 10;\n\t\t\t\t_feedBagOut := FALSE;\n\t\t\t\tClearStatus();\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF _feedToPrintOffset THEN\n\t\t\t\tstate := 20;\n\t\t\t\t_feedToPrintOffset := FALSE;\n\t\t\t\tClearStatus();\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF _reverseToSeparate THEN\n\t\t\t\t_bagSeparated := FALSE;\n\t\t\t\tstate := 50;\n\t\t\t\t_reverseToSeparate := FALSE;\n\t\t\t\tClearStatus();\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF _feedAtPrintSpeed THEN\n\t\t\t\tstate := 40;\n\t\t\t\t_feedAtPrintSpeed := FALSE;\n\t\t\t\tClearStatus();\n\t\t\tEND_IF\n\n\t10:\t\t// Feed bag out\n\t\t\tMC_MoveBagDelivery.Acceleration := MC_MoveBagDelivery.Deceleration := (feedSpeed / trapezoidalPercent);\n\t\t\tMC_MoveBagDelivery.Velocity := feedSpeed;\n\t\t\tMC_MoveBagDelivery.currentLimit := 100;\n\t\t\tMC_MoveBagDelivery.Distance := remainingLength;\n\t\t\tmoveBagDeliveryTimeout.PT := MoveTimeoutCalc(remainingLength, feedSpeed, 1000);\n\t\t\tmoveBagDeliveryTimeout.IN := TRUE;\n\t\t\tMC_MoveBagDelivery.Execute := TRUE;\n\t\t\t_logger.AddLogItem(CONCAT(_prefix, 'Feeding Bag Out'));\n\t\t\tstate := 101;\n\t\t\tnextState := 11;\n\t\t\t\n\t11:\t\t// Set Bag Feed Done\n\t\t\t_bagFeedDone := TRUE;\n\t\t\t_logger.AddLogItem(CONCAT(_prefix, 'Bag Feed Done'));\n\t\t\tstate := 0;\n\t\t\tnextState := 0;\n\t\n\t20:\t\t// Feed bag to print offset.  If already at print offset from reversing, continue\n\t\t\tIF bagReversedToPrintOffset THEN\n\t\t\t\tstate := 21;\n\t\t\t\tnextState := 0;\n\t\t\t\tbagReversedToPrintOffset := FALSE;\n\t\t\tELSE\n\t\t\t\tMC_MoveBagDelivery.Acceleration := MC_MoveBagDelivery.Deceleration := (feedSpeed / trapezoidalPercent);\n\t\t\t\tMC_MoveBagDelivery.Velocity := feedSpeed;\n\t\t\t\tMC_MoveBagDelivery.currentLimit := 100;\n\t\t\t\tMC_MoveBagDelivery.Distance := printOffset;\n\t\t\t\tremainingLength := remainingLength - printOffset;\n\t\t\t\tmoveBagDeliveryTimeout.PT := MoveTimeoutCalc(printOffset, feedSpeed, 1000);\n\t\t\t\tmoveBagDeliveryTimeout.IN := TRUE;\n\t\t\t\tMC_MoveBagDelivery.Execute := TRUE;\n\t\t\t\t_logger.AddLogItem(CONCAT(_prefix, 'Feeding Bag to Print Offset'));\n\t\t\t\tstate := 101;\n\t\t\t\tnextState := 21;\t\n\t\t\tEND_IF\n\t\n\t21: \t// Set Ready For Print\n\t\t\t_readyForPrint := TRUE;\n\t\t\tstate := 0;\n\t\t\tnextState := 0;\t\n\t\n\t50: \t// Feed bag if not over photoeye\n\t\t\tIF NOT bagPresent AND NOT dryCycleEnable THEN\n\t\t\t\tMC_MoveBagDelivery.Acceleration := MC_MoveBagDelivery.Deceleration := (reverseSpeed / trapezoidalPercent);\n\t\t\t\tMC_MoveBagDelivery.Velocity := reverseSpeed;\n\t\t\t\tMC_MoveBagDelivery.currentLimit := 100;\n\t\t\t\tMC_MoveBagDelivery.Distance := maxReverseSetpoint;\n\t\t\t\tmoveBagDeliveryTimeout.PT := MoveTimeoutCalc(maxReverseSetpoint, reverseSpeed, 1000);\n\t\t\t\tmoveBagDeliveryTimeout.IN := TRUE;\n\t\t\t\tMC_MoveBagDelivery.Execute := TRUE;\n\t\t\t\t_logger.AddLogItem(CONCAT(_prefix, 'Feed to Photoeye'));\n\t\t\t\tstate := 51;\n\t\t\tELSE\n\t\t\t\tstate := 30;\n\t\t\tEND_IF\n\t\t\t\n\t51: \t// If move completed then fault, otherwise stop at photoeye\n\t\t\tIF MC_MoveBagDelivery.Done THEN\n\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\tnoBagOverEye.Trigger();\n\t\t\t\tClearStatus();\n\t\t\t\tstate := 100;\n\t\t\t\tnextState := 0;\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF MC_MoveBagDelivery.Error OR moveBagDeliveryTimeout.Q THEN\n\t\t\t\treverseFault.Trigger();\n\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\tMC_HaltBagDelivery.Execute := TRUE;\n\t\t\t\tClearStatus();\n\t\t\t\tnextState := 0;\n\t\t\t\tstate := 100;\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF bagPresent THEN\n\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\tMC_HaltBagDelivery.Execute := TRUE;\n\t\t\t\tbagEdgePhotoeyeSim.in := FALSE;\n\t\t\t\tstate := 52;\n\t\t\t\t\n\t\t\tEND_IF\n\t\t\n\t52:\t\t// Wait for bag to stop\n\t\t\tIF MC_HaltBagDelivery.Done THEN\n\t\t\t\tMC_HaltBagDelivery.Execute := FALSE;\n\t\t\t\tstate := 30;\n\t\t\tEND_IF\n\t\n\t30:\t\t// Reverse to Separate\n\t\t\tMC_MoveBagDelivery.Acceleration := MC_MoveBagDelivery.Deceleration := (reverseSpeed / trapezoidalPercent);\n\t\t\tMC_MoveBagDelivery.Velocity := reverseSpeed;\n\t\t\tMC_MoveBagDelivery.currentLimit := 100;\n\t\t\tMC_MoveBagDelivery.Distance := maxReverseSetpoint * -1;\n\t\t\tmoveBagDeliveryTimeout.PT := MoveTimeoutCalc(maxReverseSetpoint, reverseSpeed, 1000);\n\t\t\tmoveBagDeliveryTimeout.IN := TRUE;\n\t\t\tMC_MoveBagDelivery.Execute := TRUE;\n\t\t\t_logger.AddLogItem(CONCAT(_prefix, 'Reversing to Photoeye'));\n\t\t\tbagEdgePhotoeyeSim.in := TRUE;\n\t\t\tstate := 31;\n\t\t\t//nextState := 31;\n\t\n\t31:\t\t// Stop bag once edge clears photoeye. If move command finishes that means the bag didn't separate \n\t\t\tIF MC_MoveBagDelivery.Done AND NOT dryCycleEnable THEN\n\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\tbagFailedToSeparate.Trigger();\n\t\t\t\tClearStatus();\n\t\t\t\tstate := 100;\n\t\t\t\tnextState := 0;\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF MC_MoveBagDelivery.Done AND dryCycleEnable THEN\n\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\tMC_HaltBagDelivery.Execute := FALSE;\n\t\t\t\tbagEdgePhotoeyeSim.in := FALSE;\n\t\t\t\tstate := 32;\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF MC_MoveBagDelivery.Error OR moveBagDeliveryTimeout.Q THEN\n\t\t\t\treverseFault.Trigger();\n\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\tMC_HaltBagDelivery.Execute := TRUE;\n\t\t\t\tClearStatus();\n\t\t\t\tnextState := 32;\n\t\t\t\tstate := 100;\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF NOT bagPresent AND NOT dryCycleEnable THEN\n\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\tMC_HaltBagDelivery.Execute := TRUE;\n\t\t\t\tbagEdgePhotoeyeSim.in := FALSE;\n\t\t\t\tstate := 32;\n\t\t\tEND_IF\n\t\t\n\t32: \t// Set Bag Reversed\n\t\t\tIF MC_HaltBagDelivery.Done OR dryCycleEnable THEN\n\t\t\t\tMC_HaltBagDelivery.Execute := FALSE;\n\t\t\t\tremainingLength := bagLength - sealOffset + distanceFromSealBarToBagEdge;\n\t\t\t\t_bagSeparated := TRUE;\n\t\t\t\tstate := 0;\n\t\t\t\tnextState := 0;\n\t\t\tEND_IF\n\t\t\t\n\t40:\t\t// Feed at Print Speed\n\t\t\tMC_MoveBagDelivery.Acceleration := MC_MoveBagDelivery.Deceleration := (printSpeed / trapezoidalPercent);\n\t\t\tMC_MoveBagDelivery.Velocity := printSpeed;\n\t\t\tMC_MoveBagDelivery.currentLimit := 100;\n\t\t\tMC_MoveBagDelivery.Distance := printLength + _printerExtraFeedLength;\n\t\t\tmoveBagDeliveryTimeout.PT := MoveTimeoutCalc(distanceFromNipToBagEdge, reverseSpeed, 1000);\n\t\t\tmoveBagDeliveryTimeout.IN := TRUE;\n\t\t\tMC_MoveBagDelivery.Execute := TRUE;\n\t\t\t_logger.AddLogItem(CONCAT(_prefix, 'Feeding At Print Speed'));\n\t\t\tremainingLength := remainingLength - printLength - _printerExtraFeedLength;\n\t\t\t_feedBagOut := FALSE;\n\t\t\tprintingNow := TRUE;\n\t\t\tstate := 101;\n\t\t\tnextState := 10;\n\t\n\t100:\t// Cleanup\n\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\tMC_HaltBagDelivery.Execute := FALSE;\n\t\t\tmoveBagDeliveryTimeout.IN := FALSE;\n\t\t\tbagEdgePhotoeyeSim.in := FALSE;\n\t\t\tstate := nextState;\n\t\n\t101: \t// Wait for Move to complete\n\t\t\tIF MC_MoveBagDelivery.Error OR moveBagDeliveryTimeout.Q THEN\n\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\tMC_HaltBagDelivery.Execute := TRUE;\n\t\t\t\tmoveBagDeliveryTimeout.IN := FALSE;\n\t\t\t\tClearStatus();\n\t\t\t\tnextState := 0;\n\t\t\t\tstate := 100;\n\t\t\tEND_IF\n\t\t\t\n\t\t\tIF MC_MoveBagDelivery.Done THEN\n\t\t\t\tIF printingNow THEN\n\t\t\t\t\tprinter.StopPrinting();\n\t\t\t\t\tIF printer.PrintDone THEN\n\t\t\t\t\t\tprintingNow := FALSE;\n\t\t\t\t\t\tmoveBagDeliveryTimeout.IN := FALSE;\n\t\t\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\t\t\tstate := nextState;\n\t\t\t\t\tEND_IF\n\t\t\t\tELSE\n\t\t\t\t\tmoveBagDeliveryTimeout.IN := FALSE;\n\t\t\t\t\tMC_MoveBagDelivery.Execute := FALSE;\n\t\t\t\t\tstate := nextState;\n\t\t\t\tEND_IF\n\t\t\tEND_IF\n\t\t\t\n\t103:\t// Set In Position and go back to idle\n\t\t\tnextState := 0;\n\t\t\tstate := 100;\n\t\t\t\n\t90:\t\t//Reset:\n\n\t\t_feedAtPrintSpeed := FALSE;\n\t\t_feedBagOut := FALSE;\n\t\t_feedToPrintOffset := FALSE;\n\t\t_reverseToSeparate := FALSE;\n\t\t\n\t\t//_timeoutTimer.IN := FALSE;\n\t\t//jawTestModeActive := FALSE;\n\t\t\n\t\tMC_MoveBagDelivery.execute := FALSE;\n\t\tMC_HaltBagDelivery.execute := FALSE;\n\t\tMC_ResetBagDelivery.execute := TRUE;\n\t\t//MC_PowerUpBagDelivery.execute := FALSE;\n\t\t\t\t\n\t\t\n\t\tstate := 91;\n\n\t91:\t\t//Resetting:\n\n\t\tIF  _resetTimer.Q THEN\n\t\t\tMC_ResetBagDelivery.Execute := FALSE;\t\n\t\t\tstate := 92;\n\t\tEND_IF\n\t\t\n\t92:\t\t//ResetDone:\n \t\tIF bagDeliveryMotor.operational THEN\n \t\t\tstate := 100;\n \t\tEND_IF\n\nEND_CASE","LineInfoPersistence":"(string)91e3288c-bb67-4d0f-8f4f-5d2ab405f50f_Impl_LineIds"}}}},"Interface":{"@Type":"a9ed5b7e","@Value":{"TextDocument":{"@Type":"f3878285","@Value":{"TextBlobForSerialisation":"(string)FUNCTION_BLOCK FINAL FB_1195_Test_BagDelivery EXTENDS FB_BaseComponent IMPLEMENTS IBagDelivery\nVAR_INPUT\n\tsimulateIO : BOOL;\n\tdryCycleEnable : BOOL;\n\tbagPresent : BOOL;\n\tprinter : IPrinter;\n\tbagLength : REAL := 24.0;\n\tfeedSpeed : REAL := 30.0;\n\treverseSpeed : REAL := 3.0;\n\tprintSpeed : REAL := 6.0;\n\tprintOffset : REAL := 4.5;\n\tprintLength : REAL := 6.0;\n\tmaxReverseSetpoint : REAL := 3.0;\n\tsealOffset : REAL := 1.5;\n\tdistanceFromSealBarToBagEdge : REAL := 3;\n\tdistanceFromNipToBagEdge : REAL := 1.25;\n\ttrapezoidalPercent : REAL := 0.1;\nEND_VAR\nVAR_OUTPUT\n\treverseFault : FB_Fault(name := Standard.CONCAT(_prefix,'Reverse Fault'));\n\tbagFailedToSeparate : FB_Fault(name := Standard.CONCAT(_prefix,'Failed To Separate'));\n\tnoBagOverEye : FB_Fault(name := Standard.CONCAT(_prefix,'No Bag Over Photoeye'));\n\tmotorFault : FB_Fault(name := CONCAT(_prefix, 'Film Feed Motor Fault'));\n\tmotorCommFault : FB_Fault(name := CONCAT(_prefix, 'Film Feed Motor Comm Fault'));\nEND_VAR\nVAR\n\t_feedAtPrintSpeed : BOOL;\n\t_feedBagOut : BOOL;\n\t_feedToPrintOffset : BOOL;\n\t_reverseToSeparate : BOOL;\n\t_bagFeedDone : BOOL;\n\t_bagSeparated : BOOL;\n\t_readyForPrint : BOOL;\n\t_printerExtraFeedLength : REAL := 0.25;\n\tstate : INT;\n\tnextState : INT;\n\tmoveBagDeliveryTimeout : Standard.TON;\n\tMC_MoveBagDelivery : MC_MoveRelative;\n\tMC_HaltBagDelivery : MC_Halt;\n\tMC_ResetBagDelivery : MC_Reset;\n\tMC_PowerUpBagDelivery : MC_Power;\n\tremainingLength : REAL;\n\tbagReversedToPrintOffset : BOOL;\n\tbagEdgePhotoeyeSim : FB_SimulatedFeedbackPhysicalInput(name := 'Bag Edge Photoeye Sim');\n\tprintingNow : BOOL;\n\t_resetTimer: Standard.TON := (PT := T#2S);\nEND_VAR\nVAR_IN_OUT\n\tbagDeliveryMotor : Axis_REF;\nEND_VAR","LineInfoPersistence":"(string)91e3288c-bb67-4d0f-8f4f-5d2ab405f50f_Decl_LineIds"}}}},"UniqueIdGenerator":"(string)2132","POULevel":{"@Type":"8e575c5b:Enum","@Value":"Standard"},"ChildObjectGuids":{"@Type":"ArrayList:IList","@Value":[]},"AddAttributeSubsequent":"(bool)False"}},"TypeInfos":{"0db3d7bb":"{0db3d7bb-cde0-4416-9a7b-ce49a0124323}","3b83b776":"{3b83b776-fb25-43b8-99f2-3c507c9143fc}","6f9dac99":"{6f9dac99-8de1-4efc-8465-68ac443b7d08}","8e575c5b":"{8e575c5b-1d37-49c6-941b-5c0ec7874787}","a9ed5b7e":"{a9ed5b7e-75c5-4651-af16-d2c27e98cb94}","ArrayList":"System.Collections.ArrayList","bool":"System.Boolean","f3878285":"{f3878285-8e4f-490b-bb1b-9acbb7eb04db}","string":"System.String"}}},"FormatVersion":"1.0"}